<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Razorpay </title>
</head>
<body style="font-family: Arial, sans-serif; text-align:center; margin-top:50px;">

  <h2>Yo Nutri Razorpay Payment </h2>

  <div style="margin-bottom: 20px;">
    <label for="customer_name">Name:</label>
    <input type="text" id="customer_name" placeholder="Enter your name" style="padding: 5px; font-size: 16px; width: 250px;" />
  </div>

  <div style="margin-bottom: 20px;">
    <label for="customer_email">Email:</label>
    <input type="email" id="customer_email" placeholder="Enter your email" style="padding: 5px; font-size: 16px; width: 250px;" />
  </div>

  <button id="rzp-button1" style="padding: 10px 20px; font-size:16px; cursor:pointer;">
    Pay
  </button>

  <!-- Razorpay Checkout Script -->
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
  <script>
    // Cart management functions
    const CART_KEY = 'yonutri_cart_v1';

    function loadCart() {
      try {
        return new Map(JSON.parse(localStorage.getItem(CART_KEY) || '[]'));
      } catch {
        return new Map();
      }
    }

    function formatPrice(price) {
      const num = Number(price);
      if (isNaN(num)) return '₹0';
      return '₹' + Math.floor(num).toLocaleString('en-IN');
    }

    function getCartTotal() {
      const cart = loadCart();
      let total = 0;
      for (const [key, item] of cart) {
        total += item.qty * item.price;
      }
      return total;
    }

    // Razorpay payment function
    function openRazorpayPayment(amountInRupees, customerName, customerEmail) {
      if (!amountInRupees || amountInRupees <= 0) {
        alert('Your cart is empty or invalid amount');
        return;
      }

      if (!customerName || customerName.trim() === '') {
        alert('Please enter your name');
        return;
      }

      if (!customerEmail || customerEmail.trim() === '') {
        alert('Please enter your email');
        return;
      }

      const amountInPaise = Math.round(amountInRupees * 100);

      const options = {
        key: "rzp_live_RD5dCjd57Ylvjh",
        amount: amountInPaise,
        currency: "INR",
        name: "Yo Nutri",
        description: "Purchase from Yo Nutri",
        image: "https://razorpay.com/favicon.png",
        handler: function (response) {
          alert("Payment Successful!\nPayment ID: " + response.razorpay_payment_id);

          // Send payment success details to backend to trigger email
          fetch('/api/payment-success', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              payment_id: response.razorpay_payment_id,
              order_id: null, // You can pass order ID if available
              amount: (getCartTotal()),
              email: customerEmail,
              customer_name: customerName
            })
          }).then(res => res.json())
            .then(data => {
              console.log('Payment success email response:', data);
            }).catch(err => {
              console.error('Error sending payment success email:', err);
            });

          // Clear cart after successful payment
          localStorage.removeItem(CART_KEY);
          window.location.href = 'index.html';
        },
        prefill: {
          name: customerName,
          email: customerEmail,
          contact: ""
        },
        theme: {
          color: "#FFA500"
        }
      };

      const rzp = new Razorpay(options);
      rzp.open();
    }

    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
      const payButton = document.getElementById('rzp-button1');
      const cartTotal = getCartTotal();

      if (cartTotal > 0) {
        payButton.textContent = `Pay ${formatPrice(cartTotal)}`;
        payButton.onclick = function(e) {
          const customerName = document.getElementById('customer_name').value;
          const customerEmail = document.getElementById('customer_email').value;
          openRazorpayPayment(cartTotal, customerName, customerEmail);
          e.preventDefault();
        };
      } else {
        payButton.textContent = 'Cart is Empty';
        payButton.disabled = true;
        payButton.onclick = function(e) {
          alert('Your cart is empty. Please add items to your cart first.');
          e.preventDefault();
        };
      }
    });

    // Listen for cart changes from other tabs/windows
    window.addEventListener('storage', function(e) {
      if (e.key === CART_KEY) {
        location.reload(); // Reload to update the payment amount
      }
    });
  </script>
</body>
</html>